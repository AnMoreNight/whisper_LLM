# 音声からExcelへの自動転記ツール

PyQt6 ベースのデスクトップアプリケーションです。音声ファイルを文字起こしし、ChatGPT（OpenAI API）を用いて各種帳票の入力項目を抽出・整理し、指定された Excel テンプレートへ自動で転記します。福祉サービスの支援記録や計画書作成の効率化を目的としています。

---

## 構成概要

- `app.py`
  - GUI 本体。音声ファイルの選択、文字起こし、要約／分類ワークフローの実行、進捗表示を担当します。
  - `SUMMARY_CONFIGS` で帳票ごとの実行メソッド・Excel テンプレートを定義し、`SummarizationWorker` と `ClassificationWorker` がそれぞれ要約生成・Excel 転記を行います。
  - 帳票タイプのチェックボックス選択機能により、必要な帳票のみを処理できます。
- `audio.py`
  - faster-whisper モデルを用いた音声→テキスト変換ワーカー。長時間の音声をチャンク分割しながら逐次文字起こしします。
  - VAD（Voice Activity Detection）フィルターをサポート（onnxruntime が利用可能な場合）。
- `summarizer.py`
  - OpenAI Responses API をラップしたクライアント。帳票ごとのプロンプト生成、JSON 形式での抽出、Excel への書き込み、テンプレート複製などを実装しています。
  - セル内のテキスト自動折り返し機能を実装。長文もセル内で適切に表示されます。
- `samples/`
  - 入力となる Excel テンプレート一式（上書き不可）。
- `outputs/`
  - アプリ起動時に自動生成されるタイムスタンプ付きフォルダ。各帳票テンプレートのコピーと転記結果がここに保存されます。
- `env_example`
  - `.env` 作成時に必要な環境変数の見本。
- `requirements.txt`
  - 主要依存パッケージを列挙。

---

## 主要機能

### 1. 帳票タイプの選択機能
- 出力する帳票をチェックボックスで選択可能
- 選択した帳票のみを処理することで、処理時間を短縮
- 以下の帳票タイプから選択：
  - **サービス担当者会議記録**（8種類のシートを含む）
  - **アセスメント票**
  - **サービス利用計画案**
  - **サービス利用計画**
  - **モニタリング表**

### 2. 処理の最適化
- 「サービス利用計画案」と「サービス利用計画」は実務上同じ内容のため、1回の抽出結果を両方の帳票に自動でコピー
- 不要な API 呼び出しを削減し、処理時間を短縮

### 3. Excel 出力の改善
- セル内のテキストが自動で折り返される設定
- 長文もセル内で適切に表示され、横に伸びることはありません

### 4. faster-whisper による高速文字起こし
- OpenAI Whisper の高速実装版を使用
- GPU が利用可能な場合は自動で CUDA を使用
- CPU のみの環境でも効率的に動作

---

## 必要要件

- Python 3.10 以上を推奨（3.11 または 3.12 を推奨）
- FFmpeg（pydub が音声を扱う際に必要）
- Whisper モデル用の GPU（任意、CPU でも動作可能）
- OpenAI API キー
- onnxruntime（オプション、VAD フィルターを使用する場合）

---

## セットアップ手順

1. 仮想環境を用意して依存関係をインストールします。

   ```bash
   python -m venv .venv
   .\.venv\Scripts\activate
   pip install -r requirements.txt
   ```

2. `.env` を作成し、`env_example` を参考に以下の値を設定します。

   ```env
   OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxx
   WHISPER_MODEL_SIZE=small          # tiny, base, small, medium, large-v1, large-v2
   WHISPER_DEVICE=cpu                 # cpu または cuda（GPU が利用可能な場合）
   WHISPER_COMPUTE_TYPE=int8          # int8（CPU）または float16（CUDA）
   AUDIO_CHUNK_LENGTH_SECONDS=60      # 任意設定。未指定時は 60 秒
   ```

3. Whisper モデル用に `ffmpeg` をインストールしてください（Windows の場合は PATH への追加も忘れずに）。

4. （オプション）VAD フィルターを使用する場合は、onnxruntime をインストールします。

   ```bash
   pip install onnxruntime
   # または GPU 版を使用する場合
   pip install onnxruntime-gpu
   ```

---

## 使い方（GUI）

1. `python app.py` でアプリを起動します。
2. 「音声ファイルを選択」で対象ファイル（wav/mp3/m4a/flac/aiff/ogg）を指定します。
3. **「出力する帳票を選択」セクションで、必要な帳票にチェックを入れます。**
4. 言語を選択します（デフォルト: 日本語）。
5. 「文字起こし開始」で faster-whisper による文字起こしがスタートします。右ペインのテキストエリアに進捗が表示されます。
6. 文字起こし完了後、「回答抽出」をクリックすると OpenAI へ帳票別の要約要求が送られます。**選択した帳票のみが処理されます。**
7. 「入力」で `outputs/<timestamp>/` 配下にテンプレートのコピーが生成され、抽出結果がセルに書き込まれます。**選択した帳票のみが出力されます。**
8. 生成結果は右ペインに一覧表示され、出力フォルダへのパスも確認できます。

> **補足**: 
> - 結果テキストは既定で読み取り専用ですが、「編集モード切替」ボタンで編集可能になります。手動で修正した内容をそのまま分類に流用することもできます。
> - 帳票が1つも選択されていない場合、「回答抽出」と「入力」ボタンは実行されません。
> - 「サービス利用計画案」と「サービス利用計画」の両方を選択した場合、1回の抽出結果が両方の帳票に自動でコピーされます。

---

## 対応帳票一覧

### サービス担当者会議記録（8種類のシート）
1. 特定事業所加算 保存様式
2. 入院時情報提供書
3. 退院・退所加算 保存様式
4. 居宅介護支援事業所等連携加算 保存様式
5. 医療・保育・教育連携加算 保存様式
6. サービス担当者会議記録 保存様式
7. サービス提供時モニタリング記録 保存様式
8. 体制加算 記録

### その他の帳票
- モニタリング報告書（様式11）
- サービス等利用計画案（様式4）
- サービス等利用計画（様式8）
- アセスメント票（様式2、3）

---

## フォルダ構造（抜粋）

```
audio2excel/
├─ app.py                # GUI エントリポイント
├─ audio.py              # faster-whisper 文字起こしワーカー
├─ summarizer.py         # OpenAI 推論と Excel 書き込み
├─ samples/              # 参照テンプレート（上書き禁止）
├─ outputs/              # タイムスタンプ付き出力フォルダ
├─ env_example           # .env 用のサンプル値
└─ requirements.txt      # 依存パッケージ一覧
```

---

## 環境変数

### 必須
- `OPENAI_API_KEY`: OpenAI API キー

### オプション
- `WHISPER_MODEL_SIZE`: Whisper モデルサイズ（デフォルト: `small`）
  - `tiny`, `base`, `small`, `medium`, `large-v1`, `large-v2`
- `WHISPER_DEVICE`: 実行デバイス（デフォルト: `cpu` または `cuda`）
  - `cpu`: CPU で実行
  - `cuda`: GPU で実行（利用可能な場合）
- `WHISPER_COMPUTE_TYPE`: 計算精度（デフォルト: `int8`（CPU）または `float16`（CUDA））
  - `int8`: CPU 用（高速、低精度）
  - `float16`: CUDA 用（高精度）
  - `float32`: 最高精度（遅い）
- `AUDIO_CHUNK_LENGTH_SECONDS`: 音声チャンクの長さ（秒）（デフォルト: `60`）

---

## 留意事項

- `samples/` 内のテンプレートは常に読み取り専用で扱い、アプリが自動的に `outputs/` へコピーしたファイルのみ編集してください。
- OpenAI から返却される JSON の形式が崩れた場合でも、`app.py` 側で最低限のエラーハンドリングを行い、空のテンプレートを出力します。
- faster-whisper モデルの初回読み込みには時間がかかる場合があります。モデルは自動的にダウンロードされます。
- `AUDIO_CHUNK_LENGTH_SECONDS` を短くすると UI 更新が細かくなりますが、リクエスト数が増えるため処理時間が伸びる可能性があります。
- OpenAI API の利用料金が発生します。プロンプト文の調整やフィールド数の増減は、ご利用のプランやコストに合わせて最適化してください。
- 帳票を選択しない場合、「回答抽出」と「入力」は実行されません。
- 「サービス利用計画案」と「サービス利用計画」は実務上同じ内容のため、両方を選択しても1回の API 呼び出しで済みます。
- セル内のテキストは自動で折り返されるため、長文も適切に表示されます。
- VAD フィルターを使用する場合は onnxruntime が必要ですが、インストールされていない場合でも動作します（VAD フィルターは無効化されます）。

---

## トラブルシューティング

### DLL エラー（llvmlite）が発生する場合
Python 3.13 を使用している場合、以下のバージョンを指定してインストールしてください：

```bash
pip install numba==0.59.0 llvmlite==0.42.0
```

または、Python 3.11 または 3.12 の使用を推奨します。

### VAD フィルターのエラー
onnxruntime がインストールされていない場合、VAD フィルターは自動的に無効化されます。警告メッセージが表示されますが、処理は正常に続行されます。

### GPU が認識されない場合
`WHISPER_DEVICE=cuda` を設定しても GPU が使用されない場合は、PyTorch が CUDA をサポートしているか確認してください：

```bash
python -c "import torch; print(torch.cuda.is_available())"
```

---

## ライセンス

このリポジトリにはライセンスが明示されていません。内部利用または配布条件については、依頼元の指示に従ってください。

# 音声からExcelへの自動転記ツール

PyQt6 ベースのデスクトップアプリケーションです。音声ファイルを文字起こしし、ChatGPT（OpenAI API）を用いて各種帳票の入力項目を抽出・整理し、指定された Excel テンプレートへ自動で転記します。福祉サービスの支援記録や計画書作成の効率化を目的としています。

---

## 構成概要

- `app.py`
  - GUI 本体。音声ファイルの選択、文字起こし、要約／分類ワークフローの実行、進捗表示を担当します。
  - `SUMMARY_CONFIGS` で帳票ごとの実行メソッド・Excel テンプレートを定義し、`SummarizationWorker` と `ClassificationWorker` がそれぞれ要約生成・Excel 転記を行います。
- `audio.py`
  - Whisper モデルを用いた音声→テキスト変換ワーカー。長時間の音声をチャンク分割しながら逐次文字起こしします。
- `summarizer.py`
  - OpenAI Responses API をラップしたクライアント。帳票ごとのプロンプト生成、JSON 形式での抽出、Excel への書き込み、テンプレート複製などを実装しています。
- `test.py`
  - コマンドライン用の簡易テストスクリプト。`SUMMARY_CONFIGS` をループしながら `Summarizer` の `run_*`／`insert_*` メソッドを確認できます。
- `samples/`
  - 入力となる Excel テンプレート一式（上書き不可）。
- `outputs/`
  - アプリ起動時に自動生成されるタイムスタンプ付きフォルダ。各帳票テンプレートのコピーと転記結果がここに保存されます。
- `env_example`
  - `.env` 作成時に必要な環境変数の見本。
- `requirements.txt`
  - 主要依存パッケージを列挙。

---

## 必要要件

- Python 3.10 以上を推奨
- FFmpeg（pydub が音声を扱う際に必要）
- Whisper モデル用の GPU（任意）
- OpenAI API キー

---

## セットアップ手順

1. 仮想環境を用意して依存関係をインストールします。

   ```bash
   python -m venv .venv
   .\.venv\Scripts\activate
   pip install -r requirements.txt
   ```

2. `.env` を作成し、`env_example` を参考に以下の値を設定します。

   ```env
   OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxx
   AUDIO_CHUNK_LENGTH_SECONDS=60   # 任意設定。未指定時は 60 秒
   ```

3. Whisper モデル用に `ffmpeg` をインストールしてください（Windows の場合は PATH への追加も忘れずに）。

---

## 使い方（GUI）

1. `python app.py` でアプリを起動します。
2. 「音声ファイルを選択」で対象ファイル（wav/mp3 など）を指定します。
3. 「文字起こし開始」で Whisper による文字起こしがスタートします。右ペインのテキストエリアに進捗が表示されます。
4. 文字起こし完了後、「回答抽出」をクリックすると OpenAI へ帳票別の要約要求が送られます。
5. 「分類・Excel 生成」で `outputs/<timestamp>/` 配下にテンプレートのコピーが生成され、抽出結果がセルに書き込まれます。
6. 生成結果は右ペインに一覧表示され、出力フォルダへのパスも確認できます。

> **補足**: 結果テキストは既定で読み取り専用ですが、「編集モード切替」ボタンで編集可能になります。手動で修正した内容をそのまま分類に流用することもできます。

---

## テスト実行

コマンドラインでワークフローを確認したい場合は `test.py` を使用します。サンプル文字列を `Summarizer` に渡して、各帳票の `run_*`／`insert_*` をまとめて実行します。

```bash
python test.py
```

引数やサンプルテキストの差し替えはスクリプト内で調整してください。Excel 出力先は `outputs/test_run/` になります。

---

## フォルダ構造（抜粋）

```
audio2excel/
├─ app.py                # GUI エントリポイント
├─ audio.py              # Whisper 文字起こしワーカー
├─ summarizer.py         # OpenAI 推論と Excel 書き込み
├─ test.py               # CLI テスト用スクリプト
├─ samples/              # 参照テンプレート（上書き禁止）
├─ outputs/              # タイムスタンプ付き出力フォルダ
├─ env_example           # .env 用のサンプル値
└─ requirements.txt      # 依存パッケージ一覧
```

---

## 留意事項

- `samples/` 内のテンプレートは常に読み取り専用で扱い、アプリが自動的に `outputs/` へコピーしたファイルのみ編集してください。
- OpenAI から返却される JSON の形式が崩れた場合でも、`app.py` 側で最低限のエラーハンドリングを行い、空のテンプレートを出力します。
- Whisper モデルの読み込みには時間がかかる場合があります。初回実行時はネットワーク経由でモデルを取得する点にご留意ください。
- `AUDIO_CHUNK_LENGTH_SECONDS` を短くすると UI 更新が細かくなりますが、リクエスト数が増えるため処理時間が伸びる可能性があります。
- OpenAI API の利用料金が発生します。プロンプト文の調整やフィールド数の増減は、ご利用のプランやコストに合わせて最適化してください。

---

## ライセンス

このリポジトリにはライセンスが明示されていません。内部利用または配布条件については、依頼元の指示に従ってください。


